// Generated by CoffeeScript 1.8.0

/*
  Example 1 - How to prepare a new payment with the Mollie API.
 */

(function() {
  var example, fs, mollie;

  mollie = require("./mollie");

  fs = require("fs");

  example = (function() {
    function example(request, response) {

      /*
        Generate a unique order id for this example. It is important to include this unique attribute
        in the redirectUrl (below) so a proper return page can be shown to the customer.
       */
      var orderId;
      orderId = new Date().getTime();

      /*
        Payment parameters:
          amount        Amount in EUROs. This example creates a â‚¬ 10,- payment.
          description   Description of the payment.
          redirectUrl   Redirect location. The customer will be redirected there after the payment.
          webhookUrl    Webhook location, used to report when the payment changes state.
          metadata      Custom metadata that is stored with the payment.
       */
      mollie.payments.create({
        amount: 10.00,
        description: "My first API payment",
        redirectUrl: "http://" + request.headers.host + "/3-return-page?orderId=" + orderId,
        webhookUrl: "http://" + request.headers.host + "/2-webhook-verification?orderId=" + orderId,
        metadata: {
          orderId: orderId
        }
      }, (function(_this) {
        return function(payment) {
          if (payment.error) {
            console.error(payment.error);
            return response.end();
          }

          /*
            In this example we store the order with its payment status in a database.
           */
          _this.databaseWrite(orderId, payment.status);

          /*
            Send the customer off to complete the payment.
           */
          response.writeHead(302, {
            Location: payment.getPaymentUrl()
          });
          return response.end();
        };
      })(this));
    }


    /*
      NOTE: This example uses a text file as a database. Please use a real database like MySQL in production code.
     */

    example.prototype.databaseWrite = function(orderId, paymentStatus) {
      orderId = parseInt(orderId);
      return fs.writeFile(__dirname + ("/orders/order-" + orderId + ".txt"), paymentStatus);
    };

    return example;

  })();

  module.exports = example;

}).call(this);
